/**
 * Core Philosophy: This ruleset enforces a strict, multi-tenant security model.
 * All data access and modification are restricted to authenticated administrators who are explicitly
 * designated as administrators in the `/roles_admin` collection. Each piece of data is scoped
 * to a specific gym via a `gymIdentifier`, ensuring complete data isolation between different gyms.
 *
 * Public Check-in: A specific exception is made for the public member check-in feature. This is handled
 * by creating a parallel, publicly-readable collection (`member_profiles_public`) that contains only non-sensitive
 * information required for validation. The `attendance` collection allows unauthenticated `create` operations,
 * but the request is rigorously validated against the trusted data in `member_profiles_public`. This prevents
 * unauthorized reads of private member data while still allowing a public-facing feature.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges by verifying
     * their UID exists as a document in the `/roles_admin` collection and that
     * the critical 'gymIdentifier' field has been written.
     */
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) &&
             'gymIdentifier' in get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data;
    }
    
    /**
     * Checks if the user is an admin for a specific gym.
     */
    function isGymAdmin(gymIdentifier) {
      return isAdmin() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.gymIdentifier == gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier of the currently authenticated admin user.
     */
    function getAdminGymIdentifier() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier from the member document associated with a subcollection.
     */
    function getParentMemberGymIdentifier(memberId) {
      return get(/databases/$(database)/documents/members/$(memberId)).data.gymIdentifier;
    }

    /**
     * Ensures the incoming 'memberId' field matches the parent document's ID in the path.
     */
    function hasCorrectMemberIdOnCreate(memberId) {
      return request.resource.data.memberId == memberId;
    }

    /**
     * Ensures the 'memberId' field is immutable on updates.
     */
    function isMemberIdImmutable() {
      return request.resource.data.memberId == resource.data.memberId;
    }

    /**
     * Validates a public check-in request by cross-referencing it with the trusted,
     * publicly readable `member_profiles_public` document.
     */
    function isPublicCheckInValid() {
      let incomingData = request.resource.data;
      let memberGymId = incomingData.memberGymId;

      // The corresponding public profile document, which is our source of truth.
      let publicProfile = get(/databases/$(database)/documents/member_profiles_public/$(memberGymId)).data;

      // 1. The member must be active.
      // 2. The Gym Name from the check-in must match the one in the public profile.
      // 3. The Gym Identifier must match.
      // 4. The private member document ID must match.
      return publicProfile.isActive == true &&
             publicProfile.gymName == incomingData.gymName &&
             publicProfile.gymIdentifier == incomingData.gymIdentifier &&
             publicProfile.memberDocId == incomingData.memberId;
    }

    // ------------------------------------------------------------------------
    // Rule Definitions
    // ------------------------------------------------------------------------

    /**
     * @description Protects admin roles. Any signed-in user can read an admin profile (for context),
     *              but only existing admins can list all other admins.
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if request.auth.uid == adminId;
      allow update: if request.auth.uid == adminId &&
                 (!('gymIdentifier' in resource.data) || 
                  request.resource.data.gymIdentifier == resource.data.gymIdentifier);
      allow delete: if false;
    }

    /**
     * @description Secures the main collection of gym member profiles.
     */
    match /members/{memberId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures the public-facing member profiles used for check-in.
     */
    match /member_profiles_public/{memberPubId} {
        allow get: if true;
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier);
        // Fix: Use the document's own gymIdentifier to avoid dependency on the member document during deletion.
        allow update, delete: if isGymAdmin(resource.data.gymIdentifier);
    }

    /**
     * @description Secures membership subscriptions.
     */
    match /members/{memberId}/memberships/{membershipId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier();
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && isMemberIdImmutable();
    }

    /**
     * @description Secures payment records.
     */
    match /members/{memberId}/payments/{paymentId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier();
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && isMemberIdImmutable();
    }
    
    /**
     * @description Secures the attendance collection.
     */
    match /attendance/{attendanceId} {
        allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
        allow list: if isAdmin();
        // Updated: Allow both public check-in validation and authenticated admin check-ins
        allow create: if isPublicCheckInValid() || isGymAdmin(request.resource.data.gymIdentifier);
    }
    
    /**
     * @description Secures the top-level invoices collection.
     */
    match /invoices/{invoiceId} {
        allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures membership plans.
     */
    match /membership_plans/{planId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures trainer profiles.
     */
    match /trainers/{trainerId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

  }
}
