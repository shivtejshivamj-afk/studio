/**
 * Core Philosophy: This ruleset enforces a strict, multi-tenant security model.
 * All data access and modification are restricted to authenticated administrators who are explicitly
 * designated as administrators in the `/roles_admin` collection. Each piece of data is scoped
 * to a specific gym via a `gymIdentifier`, ensuring complete data isolation between different gyms.
 *
 * Public Check-in: A specific exception is made for the public member check-in feature. This is handled
 * by creating a parallel, publicly-readable collection (`member_profiles_public`) that contains only non-sensitive
 * information required for validation. The `attendance` collection allows unauthenticated `create` operations,
 * but the request is rigorously validated against the trusted data in `member_profiles_public`. This prevents
 * unauthorized reads of private member data while still allowing a public-facing feature.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges by verifying
     * their UID exists as a document in the `/roles_admin` collection.
     * Uses get() for stronger consistency over exists().
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) != null;
    }
    
    /**
     * Checks if the user is an admin for a specific gym.
     * This is a more robust check that ensures the gymIdentifier property exists before comparison.
     */
    function isGymAdmin(gymIdentifier) {
      if (!isSignedIn()) {
        return false;
      }
      let adminDoc = get(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      // Ensure adminDoc and its data are not null, and that gymIdentifier exists.
      return adminDoc != null && 
             adminDoc.data != null &&
             'gymIdentifier' in adminDoc.data &&
             adminDoc.data.gymIdentifier == gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier of the currently authenticated admin user.
     */
    function getAdminGymIdentifier() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier from the member document associated with a subcollection.
     */
    function getParentMemberGymIdentifier(memberId) {
      return get(/databases/$(database)/documents/members/$(memberId)).data.gymIdentifier;
    }

    /**
     * Ensures the incoming 'memberId' field matches the parent document's ID in the path.
     * This enforces relational integrity when creating a new document in a subcollection.
     */
    function hasCorrectMemberIdOnCreate(memberId) {
      return request.resource.data.memberId == memberId;
    }

    /**
     * Ensures the 'memberId' field is immutable on updates. This prevents an existing
     * subcollection document from being reassigned to a different member.
     */
    function isMemberIdImmutable() {
      return request.resource.data.memberId == resource.data.memberId;
    }

    /**
     * Validates a public check-in request by cross-referencing it with the trusted,
     * publicly readable `member_profiles_public` document.
     */
    function isPublicCheckInValid() {
      let incomingData = request.resource.data;
      // The public member ID from the check-in form.
      let memberGymId = incomingData.memberGymId;

      // The corresponding public profile document, which is our source of truth.
      let publicProfile = get(/databases/$(database)/documents/member_profiles_public/$(memberGymId)).data;

      // 1. The member must be active.
      // 2. The Gym Name from the check-in must match the one in the public profile.
      // 3. The Gym Identifier must match.
      // 4. The private member document ID must match.
      return publicProfile.isActive == true &&
             publicProfile.gymName == incomingData.gymName &&
             publicProfile.gymIdentifier == incomingData.gymIdentifier &&
             publicProfile.memberDocId == incomingData.memberId;
    }

    // ------------------------------------------------------------------------
    // Rule Definitions
    // ------------------------------------------------------------------------

    /**
     * @description Protects admin roles. Any signed-in user can read an admin profile (for context),
     *              but only existing admins can list all other admins. An admin can update their own
     *              document, but critical fields are immutable to prevent data access issues.
     * @path        /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if request.auth.uid == adminId;
      allow update: if request.auth.uid == adminId && (!('gymIdentifier' in request.resource.data) ||
                      request.resource.data.gymIdentifier == resource.data.gymIdentifier);
      allow delete: if false;
    }

    /**
     * @description Secures the main collection of gym member profiles. Access is strictly scoped to the
     *              admin of the corresponding gym.
     * @path        /members/{memberId}
     */
    match /members/{memberId} {
      allow read, update, delete: if resource.data.gymIdentifier == getAdminGymIdentifier();
      allow create: if request.resource.data.gymIdentifier == getAdminGymIdentifier();
    }

    /**
     * @description Secures the public-facing member profiles used for check-in.
     *              These documents are publicly readable for the check-in process.
     *              Write operations are restricted to admins of the corresponding gym.
     * @path        /member_profiles_public/{memberPubId}
     */
    match /member_profiles_public/{memberPubId} {
        allow get: if true;
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier);
        allow update: if isGymAdmin(resource.data.gymIdentifier);
        allow delete: if isGymAdmin(resource.data.gymIdentifier);
    }

    /**
     * @description Secures membership subscriptions. Access is scoped to the admin of the parent member's gym.
     * @path        /members/{memberId}/memberships/{membershipId}
     */
    match /members/{memberId}/memberships/{membershipId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier();
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && isMemberIdImmutable();
    }

    /**
     * @description Secures payment records. Access is scoped to the admin of the parent member's gym.
     * @path        /members/{memberId}/payments/{paymentId}
     */
    match /members/{memberId}/payments/{paymentId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier();
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminGymIdentifier() && isMemberIdImmutable();
    }
    
    /**
     * @description Secures the attendance collection. Admins can read records for their gym.
     *              Public (unauthenticated) users can ONLY create new attendance records
     *              if the request is validated by the `isPublicCheckInValid` function.
     * @path        /attendance/{attendanceId}
     */
    match /attendance/{attendanceId} {
        allow read, update, delete: if resource.data.gymIdentifier == getAdminGymIdentifier();
        allow create: if isPublicCheckInValid() || request.resource.data.gymIdentifier == getAdminGymIdentifier();
    }
    
    /**
     * @description Secures the top-level invoices collection. Access is scoped to the gym admin.
     * @path        /invoices/{invoiceId}
     */
    match /invoices/{invoiceId} {
        allow read, update, delete: if resource.data.gymIdentifier == getAdminGymIdentifier();
        allow create: if request.resource.data.gymIdentifier == getAdminGymIdentifier();
    }

    /**
     * @description Secures membership plans. Access is scoped to the gym admin.
     * @path        /membership_plans/{planId}
     */
    match /membership_plans/{planId} {
      allow read, update, delete: if resource.data.gymIdentifier == getAdminGymIdentifier();
      allow create: if request.resource.data.gymIdentifier == getAdminGymIdentifier();
    }

    /**
     * @description Secures trainer profiles. Access is scoped to the gym admin.
     * @path        /trainers/{trainerId}
     */
    match /trainers/{trainerId} {
      allow read, update, delete: if resource.data.gymIdentifier == getAdminGymIdentifier();
      allow create: if request.resource.data.gymIdentifier == getAdminGymIdentifier();
    }

  }
}
