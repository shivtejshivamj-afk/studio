/**
 * Core Philosophy: This ruleset enforces a strict, administrator-only security model for most operations.
 * All data access and modification are restricted to authenticated users who are explicitly
 * designated as administrators in the `/roles_admin` collection.
 * 
 * Public Check-in: A specific exception is made for the public member check-in feature. This is handled
 * by creating a parallel, publicly-readable collection (`member_profiles_public`) that contains only non-sensitive
 * information required for validation. The `attendance` collection allows unauthenticated `create` operations,
 * but the request is rigorously validated against the trusted data in `member_profiles_public`. This prevents
 * unauthorized reads of private member data while still allowing a public-facing feature.
 *
 * Data Structure: The data is organized into top-level collections for major entities like
 * `members`, `membership_plans`, `trainers`, `attendance`, and `invoices`. This flat structure is intentional
 * to support simple queries that do not require manual index creation. Member-specific data that is
 * not queried across all members (e.g., `memberships`, `payments`) is nested in subcollections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges by verifying
     * their UID exists as a document in the `/roles_admin` collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Ensures the incoming 'memberId' field matches the parent document's ID in the path.
     * This enforces relational integrity when creating a new document in a subcollection.
     */
    function hasCorrectMemberIdOnCreate(memberId) {
      return request.resource.data.memberId == memberId;
    }

    /**
     * Ensures the 'memberId' field is immutable on updates. This prevents an existing
     * subcollection document from being reassigned to a different member.
     */
    function isMemberIdImmutable() {
      return request.resource.data.memberId == resource.data.memberId;
    }

    /**
     * Validates a public check-in request by cross-referencing it with the trusted,
     * publicly readable `member_profiles_public` document.
     */
    function isPublicCheckInValid() {
      let incomingData = request.resource.data;
      // The public member ID from the check-in form.
      let memberGymId = incomingData.memberGymId;

      // The corresponding public profile document, which is our source of truth.
      let publicProfile = get(/databases/$(database)/documents/member_profiles_public/$(memberGymId)).data;

      // 1. The member must be active.
      // 2. The Gym Name from the check-in must match the one in the public profile.
      // 3. The Gym Identifier must match.
      // 4. The private member document ID must match.
      return publicProfile.isActive == true &&
             publicProfile.gymName == incomingData.gymName &&
             publicProfile.gymIdentifier == incomingData.gymIdentifier &&
             publicProfile.memberDocId == incomingData.memberId;
    }

    // ------------------------------------------------------------------------
    // Rule Definitions
    // ------------------------------------------------------------------------

    /**
     * @description Protects admin roles. Any signed-in user can read an admin profile (for context),
     *              but only existing admins can list all other admins. An admin can update their own
     *              document, but critical fields are immutable to prevent data access issues.
     * @path        /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if request.auth.uid == adminId;
      allow update: if request.auth.uid == adminId && (!('gymName' in request.resource.data) ||
                      request.resource.data.gymName == resource.data.gymName);
      allow delete: if false;
    }

    /**
     * @description Secures the main collection of gym member profiles. Only authenticated
     *              administrators are allowed to read or write member data.
     * @path        /members/{memberId}
     */
    match /members/{memberId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Secures the public-facing member profiles used for check-in.
     *              These documents are publicly readable but can only be written by admins.
     *              This separation allows the public check-in feature to work without exposing
     *              sensitive member data.
     * @path        /member_profiles_public/{memberPubId}
     */
    match /member_profiles_public/{memberPubId} {
        allow get: if true;
        allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Secures membership subscriptions. Only admins can manage them.
     * @path        /members/{memberId}/memberships/{membershipId}
     */
    match /members/{memberId}/memberships/{membershipId} {
      allow get, list, delete: if isAdmin();
      allow create: if isAdmin() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if isAdmin() && isMemberIdImmutable();
    }

    /**
     * @description Secures payment records. Only admins can manage them.
     * @path        /members/{memberId}/payments/{paymentId}
     */
    match /members/{memberId}/payments/{paymentId} {
      allow get, list, delete: if isAdmin();
      allow create: if isAdmin() && hasCorrectMemberIdOnCreate(memberId);
      allow update: if isAdmin() && isMemberIdImmutable();
    }
    
    /**
     * @description Secures the attendance collection. Admins can read all records.
     *              Public (unauthenticated) users can ONLY create new attendance records
     *              if the request is validated by the `isPublicCheckInValid` function.
     * @path        /attendance/{attendanceId}
     */
    match /attendance/{attendanceId} {
        allow read, update, delete: if isAdmin();
        allow create: if isPublicCheckInValid() || isAdmin();
    }
    
    /**
     * @description Secures the top-level invoices collection. Only admins can read/write.
     * @path        /invoices/{invoiceId}
     */
    match /invoices/{invoiceId} {
        allow read, write: if isAdmin();
    }

    /**
     * @description Secures membership plans. Only admins can manage them.
     * @path        /membership_plans/{planId}
     */
    match /membership_plans/{planId} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Secures trainer profiles. Only admins can manage them.
     * @path        /trainers/{trainerId}
     */
    match /trainers/{trainerId} {
      allow read, write: if isAdmin();
    }

  }
}
