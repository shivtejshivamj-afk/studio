/**
 * Core Philosophy: This ruleset enforces a strict, multi-tenant security model.
 * All data access and modification are restricted to authenticated administrators who are explicitly
 * designated as administrators in the `/roles_admin` collection. Each piece of data is scoped
 * to a specific gym via a `gymIdentifier`, ensuring complete data isolation between different gyms.
 *
 * Public Check-in: A specific exception is made for the public member check-in feature. This is handled
 * by creating a parallel, publicly-readable collection (`member_profiles_public`) that contains only non-sensitive
 * information required for validation. The `attendance` collection allows unauthenticated `create` operations,
 * but the request is rigorously validated against the trusted data in `member_profiles_public`. This prevents
 * unauthorized reads of private member data while still allowing a public-facing feature.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Gets the data of the currently authenticated admin user.
     */
    function getAdminData() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data;
    }

    /**
     * Checks if the user is an admin for a specific gym.
     */
    function isGymAdmin(gymIdentifier) {
      return isAdmin() && getAdminData().gymIdentifier == gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier from the member document associated with a subcollection.
     */
    function getParentMemberGymIdentifier(memberId) {
      let memberPath = /databases/$(database)/documents/members/$(memberId);
      return exists(memberPath) ? get(memberPath).data.gymIdentifier : null;
    }

    /**
     * Ensures the incoming 'memberId' field matches the parent document's ID in the path.
     */
    function hasCorrectMemberIdOnCreate(memberId) {
      return request.resource.data.memberId == memberId;
    }

    /**
     * Ensures the 'memberId' field is immutable on updates.
     */
    function isMemberIdImmutable() {
      return request.resource.data.memberId == resource.data.memberId;
    }

    /**
     * Validates a public check-in request by cross-referencing it with the trusted,
     * publicly readable `member_profiles_public` document.
     */
    function isPublicCheckInValid() {
      let incomingData = request.resource.data;
      let memberGymId = incomingData.memberGymId;
      let publicProfilePath = /databases/$(database)/documents/member_profiles_public/$(memberGymId);

      // 1. The profile must exist.
      // 2. The member must be active.
      // 3. The Gym Name from the check-in must match the one in the public profile.
      // 4. The Gym Identifier must match.
      // 5. The private member document ID must match.
      return exists(publicProfilePath) &&
             get(publicProfilePath).data.isActive == true &&
             get(publicProfilePath).data.gymName == incomingData.gymName &&
             get(publicProfilePath).data.gymIdentifier == incomingData.gymIdentifier &&
             get(publicProfilePath).data.memberDocId == incomingData.memberId;
    }

    // ------------------------------------------------------------------------
    // Rule Definitions
    // ------------------------------------------------------------------------

    /**
     * @description Protects admin roles.
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if request.auth.uid == adminId;
      allow update: if request.auth.uid == adminId &&
                 (!('gymIdentifier' in resource.data) || 
                  request.resource.data.gymIdentifier == resource.data.gymIdentifier);
      allow delete: if false;
    }

    /**
     * @description Secures the main collection of gym member profiles.
     */
    match /members/{memberId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures the public-facing member profiles used for check-in.
     */
    match /member_profiles_public/{memberPubId} {
        allow get: if true;
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier);
        allow update, delete: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures membership subscriptions.
     */
    match /members/{memberId}/memberships/{membershipId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier;
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier && isMemberIdImmutable();
    }

    /**
     * @description Secures payment records.
     */
    match /members/{memberId}/payments/{paymentId} {
      allow get, list, delete: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier;
      allow create: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier && hasCorrectMemberIdOnCreate(memberId);
      allow update: if getParentMemberGymIdentifier(memberId) == getAdminData().gymIdentifier && isMemberIdImmutable();
    }
    
    /**
     * @description Secures the attendance collection.
     */
    match /attendance/{attendanceId} {
        allow get: if true; 
        allow update, delete: if isGymAdmin(resource.data.gymIdentifier);
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier) || isPublicCheckInValid();
    }
    
    /**
     * @description Secures the top-level invoices collection.
     */
    match /invoices/{invoiceId} {
        allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
        allow list: if isAdmin();
        allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures membership plans.
     */
    match /membership_plans/{planId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

    /**
     * @description Secures trainer profiles.
     */
    match /trainers/{trainerId} {
      allow get, update, delete: if isGymAdmin(resource.data.gymIdentifier);
      allow list: if isAdmin();
      allow create: if isGymAdmin(request.resource.data.gymIdentifier);
    }

  }
}