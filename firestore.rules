/**
 * Core Philosophy: This ruleset enforces a strict, multi-tenant security model.
 * All data access and modification are restricted to authenticated administrators who are explicitly
 * designated as administrators in the `/roles_admin` collection. Each piece of data is scoped
 * to a specific gym via a `gymIdentifier`, ensuring complete data isolation between different gyms.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has administrative privileges.
     */
    function isAdmin() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) ||
        // Backup check if the existence check is in-flight
        request.auth.token.role == 'admin'
      );
    }
    
    /**
     * Gets the data of the currently authenticated admin user.
     */
    function getAdminData() {
      return get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data;
    }

    /**
     * Checks if the user is an admin for a specific gym.
     */
    function isGymAdmin(gymIdentifier) {
      return isAdmin() && getAdminData().gymIdentifier == gymIdentifier;
    }
    
    /**
     * Gets the gymIdentifier from the member document associated with a subcollection.
     */
    function getParentMemberGymIdentifier(memberId) {
      let memberPath = /databases/$(database)/documents/members/$(memberId);
      return exists(memberPath) ? get(memberPath).data.gymIdentifier : null;
    }

    /**
     * Validates a public check-in request by cross-referencing it with the trusted,
     * publicly readable `member_profiles_public` document.
     */
    function isPublicCheckInValid() {
      let incomingData = request.resource.data;
      let memberGymId = incomingData.memberGymId;
      let publicProfilePath = /databases/$(database)/documents/member_profiles_public/$(memberGymId);

      // 1. The profile must exist.
      // 2. The member must be active.
      // 3. The Gym Name from the check-in must match the one in the public profile.
      // 4. The Gym Identifier must match.
      // 5. The private member document ID must match.
      return exists(publicProfilePath) &&
             get(publicProfilePath).data.isActive == true &&
             get(publicProfilePath).data.gymName == incomingData.gymName &&
             get(publicProfilePath).data.gymIdentifier == incomingData.gymIdentifier &&
             get(publicProfilePath).data.memberDocId == incomingData.memberId;
    }

    // ------------------------------------------------------------------------
    // Rule Definitions
    // ------------------------------------------------------------------------

    /**
     * @description Protects admin roles.
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if request.auth.uid == adminId;
      allow update: if request.auth.uid == adminId &&
                 (!('gymIdentifier' in resource.data) || 
                  request.resource.data.gymIdentifier == resource.data.gymIdentifier);
      allow delete: if false;
    }

    /**
     * @description Secures the main collection of gym member profiles.
     */
    match /members/{memberId} {
      allow get, update, delete: if isAdmin() && (resource.data.gymIdentifier == getAdminData().gymIdentifier);
      allow list: if isAdmin();
      allow create: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
    }

    /**
     * @description Secures the public-facing member profiles used for check-in.
     */
    match /member_profiles_public/{memberPubId} {
        allow get: if true;
        allow list: if isAdmin();
        allow create: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
        allow update, delete: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
    }

    /**
     * @description Secures membership subscriptions.
     */
    match /members/{memberId}/memberships/{membershipId} {
      allow get, list, delete: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId);
      allow create: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId) && request.resource.data.memberId == memberId;
      allow update: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId) && request.resource.data.memberId == resource.data.memberId;
    }

    /**
     * @description Secures payment records.
     */
    match /members/{memberId}/payments/{paymentId} {
      allow get, list, delete: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId);
      allow create: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId) && request.resource.data.memberId == memberId;
      allow update: if isAdmin() && getAdminData().gymIdentifier == getParentMemberGymIdentifier(memberId) && request.resource.data.memberId == resource.data.memberId;
    }
    
    /**
     * @description Secures the attendance collection.
     */
    match /attendance/{attendanceId} {
        allow get: if true; 
        allow list: if isAdmin();
        // Allow create if authenticated admin OR valid public check-in
        allow create: if isAdmin() || isPublicCheckInValid();
        // Allow update/delete for authenticated administrators
        allow update, delete: if isAdmin();
    }
    
    /**
     * @description Secures the top-level invoices collection.
     */
    match /invoices/{invoiceId} {
        allow get, update, delete: if isAdmin() && (resource.data.gymIdentifier == getAdminData().gymIdentifier);
        allow list: if isAdmin();
        allow create: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
    }

    /**
     * @description Secures membership plans.
     */
    match /membership_plans/{planId} {
      allow get, update, delete: if isAdmin() && (resource.data.gymIdentifier == getAdminData().gymIdentifier);
      allow list: if isAdmin();
      allow create: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
    }

    /**
     * @description Secures trainer profiles.
     */
    match /trainers/{trainerId} {
      allow get, update, delete: if isAdmin() && (resource.data.gymIdentifier == getAdminData().gymIdentifier);
      allow list: if isAdmin();
      allow create: if isAdmin() && (request.resource.data.gymIdentifier == getAdminData().gymIdentifier);
    }

  }
}